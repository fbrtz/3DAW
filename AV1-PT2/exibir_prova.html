<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realizar Prova</title>
    <style>
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .questao { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .pergunta { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .alternativas label { display: block; margin-bottom: 10px; padding: 8px; border: 1px solid #eee; border-radius: 3px; cursor: pointer; }
        .alternativas label:hover { background-color: #f9f9f9; }
        .alternativas label.selected { background-color: #e3f2fd; border-color: #2196f3; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 3px; resize: vertical; }
        .loading { color: #666; font-style: italic; }
        .error { color: red; }
        .success { color: green; }
        .navegacao { margin-top: 20px; display: flex; justify-content: space-between; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .status-salvo { color: green; font-size: 12px; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prova Online</h1>
        
        <div id="loading" class="loading">Carregando questão...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
        
        <div id="questao-container" style="display: none;">
            <div class="questao">
                <div style="display: flex; align-items: center;">
                    <div id="numero-questao" class="pergunta"></div>
                    <span id="status-salvo" class="status-salvo" style="display: none;">✓ Salvo</span>
                </div>
                <div id="texto-pergunta" class="pergunta"></div>
                
                <form id="form-resposta">
                    <input type="hidden" id="numquestao" name="numquestao">
                    <input type="hidden" id="pergunta" name="pergunta">
                    
                    <div id="alternativas-container" class="alternativas" style="display: none;">
                        <!-- Alternativas serão inseridas aqui via JavaScript -->
                    </div>
                    
                    <div id="discursiva-container" style="display: none;">
                        <textarea id="resposta-discursiva" name="resposta" rows="5" placeholder="Digite sua resposta aqui..."></textarea>
                    </div>
                </form>
            </div>
            
            <div class="navegacao">
                <button id="btn-anterior" onclick="questaoAnterior()">← Anterior</button>
                <button id="btn-proxima" onclick="proximaQuestao()">Próxima →</button>
                <button id="btn-finalizar" onclick="finalizarProva()" style="display: none;">Finalizar Prova</button>
            </div>
        </div>
    </div>

    <script>
        let questaoAtual = 1;
        let totalQuestoes = 0;
        let questaoAtualTipo = ''; // 'objetiva' ou 'discursiva'

        function carregarQuestao(numero) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('status-salvo').style.display = 'none'; // SEMPRE esconder ao carregar nova questão
            document.getElementById('questao-container').style.display = 'none';

            const xhr = new XMLHttpRequest();
            xhr.open('GET', `crud_respostas/obter_questao.php?q=${numero}`, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    document.getElementById('loading').style.display = 'none';
                    
                    if (xhr.status === 200) {
                        try {
                            const resposta = JSON.parse(xhr.responseText);
                            
                            if (resposta.success) {
                                exibirQuestao(resposta.data);
                                questaoAtual = numero;
                                atualizarBotoesNavegacao();
                            } else {
                                if (numero === 1) {
                                    mostrarErro('Nenhuma questão encontrada');
                                } else {
                                    // Última questão alcançada
                                    totalQuestoes = numero - 1;
                                    document.getElementById('btn-finalizar').style.display = 'block';
                                    mostrarSucesso('Todas as questões foram respondidas! Redirecionando...');
                                    setTimeout(() => {
                                        window.location.href = "crud_respostas/listar_respostas.html";
                                    }, 3000);
                                }
                            }
                        } catch (e) {
                            mostrarErro('Erro ao processar questão: ' + e.message);
                        }
                    } else {
                        mostrarErro('Erro ao carregar questão: ' + xhr.status);
                    }
                }
            };
            xhr.send();
        }

        function exibirQuestao(questao) {
            document.getElementById('numero-questao').textContent = `Questão ${questao.numero}`;
            document.getElementById('texto-pergunta').textContent = questao.pergunta;
            document.getElementById('numquestao').value = questao.numero;
            document.getElementById('pergunta').value = questao.pergunta;

            // Limpar respostas anteriores e estados visuais
            document.getElementById('alternativas-container').innerHTML = '';
            document.getElementById('resposta-discursiva').value = '';
            document.querySelectorAll('.alternativas label').forEach(label => {
                label.classList.remove('selected');
            });

            if (questao.discursiva) {
                questaoAtualTipo = 'discursiva';
                document.getElementById('alternativas-container').style.display = 'none';
                document.getElementById('discursiva-container').style.display = 'block';
            } else {
                questaoAtualTipo = 'objetiva';
                document.getElementById('discursiva-container').style.display = 'none';
                document.getElementById('alternativas-container').style.display = 'block';
                
                const alternativasContainer = document.getElementById('alternativas-container');
                
                for (const [letra, texto] of Object.entries(questao.alternativas)) {
                    if (texto.trim() !== '') {
                        const label = document.createElement('label');
                        label.innerHTML = `
                            <input type="radio" name="resposta" value="${letra}">
                            ${letra}) ${texto}
                        `;
                        alternativasContainer.appendChild(label);
                    }
                }

                // Adicionar event listeners para as alternativas recém-criadas
                adicionarEventListenersAlternativas();
            }

            // Carregar resposta salva anteriormente (se existir)
            carregarRespostaSalva(questao.numero);
            
            document.getElementById('questao-container').style.display = 'block';
        }

        function adicionarEventListenersAlternativas() {
            const radios = document.querySelectorAll('input[name="resposta"]');
            radios.forEach(radio => {
                // Remover event listener existente para evitar duplicação
                radio.replaceWith(radio.cloneNode(true));
            });

            // Adicionar novos event listeners
            const novosRadios = document.querySelectorAll('input[name="resposta"]');
            novosRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Destacar a alternativa selecionada
                    document.querySelectorAll('.alternativas label').forEach(label => {
                        label.classList.remove('selected');
                    });
                    if (this.checked) {
                        this.parentElement.classList.add('selected');
                    }
                    
                    salvarResposta();
                });
            });
        }

        function carregarRespostaSalva(numeroQuestao) {
            const respostaSalva = localStorage.getItem(`resposta_${numeroQuestao}`);
            if (respostaSalva && respostaSalva.trim() !== '') {
                if (questaoAtualTipo === 'discursiva') {
                    document.getElementById('resposta-discursiva').value = respostaSalva;
                    // Mostrar status salvo apenas se houver texto
                    if (respostaSalva.trim() !== '') {
                        document.getElementById('status-salvo').style.display = 'inline';
                    }
                } else {
                    const radio = document.querySelector(`input[name="resposta"][value="${respostaSalva}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.parentElement.classList.add('selected');
                        // Mostrar status salvo apenas se houver alternativa selecionada
                        document.getElementById('status-salvo').style.display = 'inline';
                    }
                }
            }
        }

        function salvarResposta() {
            const numquestao = document.getElementById('numquestao').value;
            const pergunta = document.getElementById('pergunta').value;
            
            let resposta = '';
            let temResposta = false;
            
            if (questaoAtualTipo === 'discursiva') {
                resposta = document.getElementById('resposta-discursiva').value;
                temResposta = resposta.trim() !== '';
            } else {
                const radioSelecionado = document.querySelector('input[name="resposta"]:checked');
                resposta = radioSelecionado ? radioSelecionado.value : '';
                temResposta = resposta !== '';
            }

            if (!temResposta) {
                // Se não tem resposta, esconder o status e não salvar
                document.getElementById('status-salvo').style.display = 'none';
                return false;
            }

            // Salvar localmente para persistência durante a prova
            localStorage.setItem(`resposta_${numquestao}`, resposta);

            const formData = new FormData();
            formData.append('numquestao', numquestao);
            formData.append('pergunta', pergunta);
            formData.append('resposta', resposta);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'crud_respostas/salvar_resposta.php', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    try {
                        const respostaServidor = JSON.parse(xhr.responseText);
                        if (respostaServidor.success) {
                            document.getElementById('status-salvo').style.display = 'inline';
                            // Mostrar mensagem de sucesso temporária
                            mostrarSucessoTemporario('Resposta salva!');
                        } else {
                            mostrarErro('Erro ao salvar resposta: ' + respostaServidor.message);
                            document.getElementById('status-salvo').style.display = 'none';
                        }
                    } catch (e) {
                        console.error('Erro ao processar resposta do servidor:', e);
                        document.getElementById('status-salvo').style.display = 'none';
                    }
                }
            };
            xhr.send(formData);

            return true;
        }

        function mostrarSucessoTemporario(mensagem) {
            const successElement = document.getElementById('success');
            successElement.textContent = mensagem;
            successElement.style.display = 'block';
            successElement.style.opacity = '1';
            
            // Fade out após 2 segundos
            setTimeout(() => {
                successElement.style.opacity = '0';
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 500);
            }, 2000);
        }

        function questaoAnterior() {
            // Sempre esconder o status ao mudar de questão
            document.getElementById('status-salvo').style.display = 'none';
            
            if (salvarResposta() || confirm('Deseja prosseguir sem salvar a resposta?')) {
                if (questaoAtual > 1) {
                    carregarQuestao(questaoAtual - 1);
                }
            }
        }

        function proximaQuestao() {
            // Sempre esconder o status ao mudar de questão
            document.getElementById('status-salvo').style.display = 'none';
            
            if (salvarResposta() || confirm('Deseja prosseguir sem salvar a resposta?')) {
                carregarQuestao(questaoAtual + 1);
            }
        }

        function finalizarProva() {
            if (confirm('Tem certeza que deseja finalizar a prova? Você não poderá alterar as respostas depois.')) {
                // Salvar última resposta
                salvarResposta();
                
                // Redirecionar para listagem de respostas
                window.location.href = 'crud_respostas/listar_respostas.html';
            }
        }

        function atualizarBotoesNavegacao() {
            document.getElementById('btn-anterior').disabled = (questaoAtual === 1);
        }

        function mostrarErro(mensagem) {
            document.getElementById('error').textContent = mensagem;
            document.getElementById('error').style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }

        function mostrarSucesso(mensagem) {
            document.getElementById('success').textContent = mensagem;
            document.getElementById('success').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }

        // Carregar primeira questão ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarQuestao(1);
        });

        // Salvar automaticamente texto discursivo (com debounce)
        let timeoutResposta;
        document.addEventListener('input', function(e) {
            if (e.target.id === 'resposta-discursiva') {
                clearTimeout(timeoutResposta);
                timeoutResposta = setTimeout(salvarResposta, 1000);
            }
        });

        // Também salvar discursiva quando perder o foco
        document.addEventListener('blur', function(e) {
            if (e.target.id === 'resposta-discursiva') {
                salvarResposta();
            }
        }, true);
    </script>
</body>
</html>